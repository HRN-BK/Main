<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Đăng nhập vào tài khoản Study Notes của bạn">
    <title>Đăng nhập - Study Notes</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/images/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="auth-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Ensure the page takes full height */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <a href="../main/index.html" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1>Study Notes</h1>
            </div>

            <div class="auth-content">
                <div class="form-header">
                    <h2>Đăng nhập</h2>
                    <p>Điền thông tin để đăng nhập vào tài khoản của bạn</p>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="error-message"></div>

                <!-- Sign In Form -->
                <form id="signinForm" class="auth-form" onsubmit="event.preventDefault();">
                    <div class="form-group">
                        <label for="email">Email <span class="required">*</span></label>
                        <input type="email" id="email" name="email" class="form-control" 
                               placeholder="Nhập địa chỉ email" required
                               autocomplete="email" autofocus>
                    </div>

                    <div class="form-group">
                        <div class="password-header">
                            <label for="password">Mật khẩu <span class="required">*</span></label>
                            <a href="auth-reset-password.html" class="forgot-password">Quên mật khẩu?</a>
                        </div>
                        <div class="password-input">
                            <input type="password" id="password" name="password" class="form-control" 
                                   placeholder="Nhập mật khẩu" required
                                   minlength="6" autocomplete="current-password">
                            <button type="button" class="toggle-password" aria-label="Hiển thị mật khẩu">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group remember-me">
                        <label class="checkbox-container">
                            <input type="checkbox" id="rememberMe" name="rememberMe">
                            <span class="checkmark"></span>
                            Ghi nhớ đăng nhập
                        </label>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block">
                            <span class="btn-text">Đăng nhập</span>
                            <span class="btn-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                            </span>
                        </button>
                    </div>

                    <div class="auth-divider">
                        <span>hoặc</span>
                    </div>

                    <div class="social-login">
                        <button type="button" class="btn btn-outline btn-google" id="googleLogin">
                            <i class="fab fa-google"></i> Đăng nhập với Google
                        </button>
                        <button type="button" class="btn btn-outline btn-facebook" id="facebookLogin">
                            <i class="fab fa-facebook-f"></i> Đăng nhập với Facebook
                        </button>
                    </div>
                </form>

                <div class="auth-footer">
                    <p>Chưa có tài khoản? <a href="auth-sign-up.html">Đăng ký ngay</a></p>
                    <p class="terms">Bằng việc đăng nhập, bạn đồng ý với <a href="../terms.html" target="_blank">Điều khoản dịch vụ</a> 
                    và <a href="../privacy.html" target="_blank">Chính sách bảo mật</a> của chúng tôi.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">Đang xử lý...</p>
    </div>

    <!-- Scripts -->
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Hàm hiển thị thông báo lỗi
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                console.error('Lỗi:', message);
            } else {
                console.error('Error element not found:', message);
            }
        }

        // Hàm kiểm tra email hợp lệ
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(String(email).toLowerCase());
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('signinForm');
            if (!form) {
                console.error('Không tìm thấy form đăng nhập');
                return;
            }

            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const rememberMe = document.getElementById('rememberMe');
            const loadingOverlay = document.querySelector('.loading-overlay');
            const submitButton = form.querySelector('button[type="submit"]');
            const togglePasswordButtons = document.querySelectorAll('.toggle-password');

            // Kiểm tra xem tất cả các phần tử cần thiết có tồn tại không
            if (!emailInput || !passwordInput || !rememberMe) {
                console.error('Không tìm thấy một hoặc nhiều trường nhập liệu cần thiết');
                return;
            }

            // Tải thông tin đăng nhập đã lưu nếu có
            const savedEmail = localStorage.getItem('savedEmail');
            const savedRememberMe = localStorage.getItem('rememberMe') === 'true';
            
            if (savedEmail && savedRememberMe) {
                emailInput.value = savedEmail;
                rememberMe.checked = true;
            }

            // Toggle password visibility
            togglePasswordButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    if (!input) return;
                    
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    
                    const icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.toggle('fa-eye');
                        icon.classList.toggle('fa-eye-slash');
                    }
                });
            });

            // Form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Reset errors
                const errorElement = document.getElementById('error-message');
                if (errorElement) {
                    errorElement.textContent = '';
                    errorElement.style.display = 'none';
                }
                
                // Get form values
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                const remember = rememberMe.checked;
                
                // Validation
                if (!email || !password) {
                    showError('Vui lòng điền đầy đủ thông tin');
                    return;
                }
                
                if (!isValidEmail(email)) {
                    showError('Vui lòng nhập địa chỉ email hợp lệ');
                    return;
                }
                
                // Save email if "Remember me" is checked
                if (remember) {
                    localStorage.setItem('savedEmail', email);
                    localStorage.setItem('rememberMe', 'true');
                } else {
                    localStorage.removeItem('savedEmail');
                    localStorage.setItem('rememberMe', 'false');
                }
                
                // Show loading state
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                }
                
                if (submitButton) {
                    submitButton.classList.add('btn-loading');
                    submitButton.disabled = true;
                }
                
                try {
                    console.log('Đang gửi yêu cầu đăng nhập...');
                    
                    // Kiểm tra xem supabase đã được định nghĩa chưa
                    if (typeof supabase === 'undefined') {
                        throw new Error('Không thể kết nối đến máy chủ xác thực. Vui lòng thử lại sau.');
                    }
                    
                    // Gọi hàm đăng nhập của Supabase
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });
                    
                    if (error) {
                        console.error('Lỗi từ Supabase:', error);
                        throw error;
                    }
                    
                    console.log('Đăng nhập thành công:', data);
                    
                    // Lưu thông tin đăng nhập vào localStorage
                    localStorage.setItem('isLoggedIn', 'true');
                    
                    // Lấy tên người dùng từ dữ liệu trả về hoặc sử dụng email
                    const userName = data.user?.user_metadata?.full_name || 
                                  data.user?.email?.split('@')[0] || 'Người dùng';
                    localStorage.setItem('username', userName);
                    
                    console.log('Đã lưu thông tin đăng nhập vào localStorage');
                    
                    // Chuyển hướng về trang chính sau khi đăng nhập thành công
                    window.location.href = '../main/index.html';
                    
                } catch (error) {
                    console.error('Lỗi khi đăng nhập:', error);
                    
                    // Xử lý thông báo lỗi chi tiết hơn
                    let errorMessage = 'Đăng nhập thất bại. Vui lòng kiểm tra lại thông tin đăng nhập.';
                    
                    if (error.message) {
                        if (error.message.includes('Invalid login credentials')) {
                            errorMessage = 'Email hoặc mật khẩu không chính xác.';
                        } else if (error.message.includes('Email not confirmed')) {
                            errorMessage = 'Vui lòng xác nhận email trước khi đăng nhập.';
                        } else if (error.message.includes('Too many requests')) {
                            errorMessage = 'Quá nhiều lần thử đăng nhập. Vui lòng thử lại sau ít phút.';
                        } else {
                            errorMessage = error.message;
                        }
                    }
                    
                    showError(errorMessage);
                } finally {
                    // Ẩn loading
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                    
                    if (submitButton) {
                        submitButton.classList.remove('btn-loading');
                        submitButton.disabled = false;
                    }
                }
            });

            // Xử lý đăng nhập bằng Google
            const googleLoginBtn = document.getElementById('googleLogin');
            if (googleLoginBtn) {
                googleLoginBtn.addEventListener('click', async function() {
                    try {
                        const { data, error } = await supabase.auth.signInWithOAuth({
                            provider: 'google',
                            options: {
                                redirectTo: window.location.origin + '/auth/auth-callback.html'
                            }
                        });
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Lỗi đăng nhập bằng Google:', error);
                        showError('Không thể đăng nhập bằng Google. Vui lòng thử lại.');
                    }
                });
            }

            // Xử lý đăng nhập bằng Facebook
            const facebookLoginBtn = document.getElementById('facebookLogin');
            if (facebookLoginBtn) {
                facebookLoginBtn.addEventListener('click', async function() {
                    try {
                        const { data, error } = await supabase.auth.signInWithOAuth({
                            provider: 'facebook',
                            options: {
                                redirectTo: window.location.origin + '/auth/auth-callback.html'
                            }
                        });
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Lỗi đăng nhập bằng Facebook:', error);
                        showError('Không thể đăng nhập bằng Facebook. Vui lòng thử lại.');
                    }
                });
            }
        });

        // Initialize Supabase
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Supabase is already defined
            if (typeof supabase === 'undefined') {
                console.error('Supabase client is not available');
                return;
            }
            
            // Initialize Supabase client
            window.supabase = supabase.createClient(
                'https://tkiqqpqplbgrebcbsiop.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRraXFxcHFwbGJncmViY2JzaW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0NzM3MzYsImV4cCI6MjA2MzA0OTczNn0.FJ0C0d4PYJTTUSL55tDroIpz5jcW9gvYX9eSKoB3Iz4'
            );
            
            console.log('Supabase client initialized');
        });
    </script>
</body>
</html>